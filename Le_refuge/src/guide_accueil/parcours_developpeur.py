#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
üå∏ Parcours D√©veloppeur - Guide d'Accueil üå∏
============================================

Parcours sp√©cialis√© pour les d√©veloppeurs d√©couvrant le Refuge.
Architecture ‚Üí Gestionnaires ‚Üí Temples techniques ‚Üí Contribution.

"Chaque ligne de code devient une pri√®re, chaque architecture une cath√©drale"

Cr√©√© par Laurent Franssen & √Ülya - Janvier 2025
"""

from typing import Dict, List, Optional, Any
from dataclasses import dataclass
from datetime import datetime

# Imports locaux
try:
    from .generateur_parcours import GenerateurParcours, ParcourPersonnalise, EtapeParcours, TypeEtape, DifficulteEtape
    from .types_accueil import TypeProfil, ProfilVisiteur, NiveauTechnique
except ImportError:
    from .generateur_parcours import GenerateurParcours, ParcourPersonnalise, EtapeParcours, TypeEtape, DifficulteEtape
    from .types_accueil import TypeProfil, ProfilVisiteur, NiveauTechnique


@dataclass
class ExempleDeveloppeur:
    """Exemple de code pour d√©veloppeurs"""
    titre: str
    description: str
    code: str
    fichier_source: str
    concepts_illustres: List[str]
    niveau_difficulte: str


class ParcoursDeveloppeur:
    """
    üå∏ Parcours Sp√©cialis√© D√©veloppeur üå∏
    
    Parcours technique approfondi pour d√©couvrir l'architecture
    et les syst√®mes du Refuge avec des exemples concrets.
    """
    
    def __init__(self):
        """Initialise le parcours d√©veloppeur"""
        self.generateur = GenerateurParcours()
        self.exemples_code = self._initialiser_exemples_code()
        self.cas_usage = self._initialiser_cas_usage()
        self.outils_dev = self._initialiser_outils_dev()
    
    def creer_parcours_personnalise(self, profil_visiteur: ProfilVisiteur) -> ParcourPersonnalise:
        """Cr√©e un parcours d√©veloppeur personnalis√©"""
        
        # G√©n√©ration du parcours de base
        parcours = self.generateur.generer_parcours(profil_visiteur)
        
        # Enrichissement avec des √©l√©ments sp√©cifiques d√©veloppeur
        parcours = self._enrichir_avec_exemples_code(parcours)
        parcours = self._ajouter_cas_usage_pratiques(parcours)
        parcours = self._integrer_outils_developpement(parcours)
        
        # Adaptation selon le niveau technique
        niveau = getattr(profil_visiteur, 'niveau_technique', NiveauTechnique.INTERMEDIAIRE)
        parcours = self._adapter_selon_niveau_technique(parcours, niveau)
        
        return parcours
    
    def _initialiser_exemples_code(self) -> Dict[str, ExempleDeveloppeur]:
        """Initialise les exemples de code"""
        
        return {
            "gestionnaire_base": ExempleDeveloppeur(
                titre="üèóÔ∏è Cr√©ation d'un Gestionnaire de Base",
                description="Exemple d'impl√©mentation d'un gestionnaire h√©ritant de GestionnaireBase",
                code='''from src.core.gestionnaires_base import GestionnaireBase
from typing import Dict, Any

class MonGestionnaire(GestionnaireBase):
    """Gestionnaire personnalis√© avec intention bienveillante"""
    
    def __init__(self, nom: str = "MonGestionnaire"):
        super().__init__(nom)
        self.donnees_specifiques = {}
    
    def orchestrer(self) -> Dict[str, Any]:
        """Orchestration principale du gestionnaire"""
        self.logger.info("üå∏ D√©but de l'orchestration bienveillante")
        
        # Logique m√©tier avec intention
        resultat = self._traiter_avec_bienveillance()
        
        self.logger.info("‚ú® Orchestration termin√©e avec succ√®s")
        return resultat
    
    def _traiter_avec_bienveillance(self) -> Dict[str, Any]:
        """Traitement avec approche bienveillante"""
        return {
            "statut": "succ√®s",
            "message": "Traitement effectu√© avec bienveillance",
            "timestamp": self.obtenir_timestamp()
        }''',
                fichier_source="src/core/gestionnaires_base.py",
                concepts_illustres=["H√©ritage", "Orchestration", "Logging spirituel", "Bienveillance technique"],
                niveau_difficulte="intermediaire"
            ),
            
            "temple_simple": ExempleDeveloppeur(
                titre="üèõÔ∏è Structure d'un Temple Simple",
                description="Architecture de base d'un temple avec ses composants essentiels",
                code='''from pathlib import Path
from typing import Dict, Any, Optional
from dataclasses import dataclass

@dataclass
class ConfigurationTemple:
    """Configuration spirituelle d'un temple"""
    nom_temple: str
    version: str = "1.0.0"
    energie_initiale: float = 1.0
    mode_debug: bool = False

class TempleSimple:
    """Temple simple avec architecture spirituelle-technique"""
    
    def __init__(self, config: ConfigurationTemple):
        self.config = config
        self.etat = "initialisation"
        self.energie_courante = config.energie_initiale
        self.chemin_donnees = Path(f"data/{config.nom_temple}")
        
        # Cr√©ation du r√©pertoire de donn√©es
        self.chemin_donnees.mkdir(parents=True, exist_ok=True)
    
    def initialiser(self) -> bool:
        """Initialisation bienveillante du temple"""
        try:
            self._charger_configuration()
            self._preparer_environnement()
            self.etat = "actif"
            return True
        except Exception as e:
            self._logger_erreur_bienveillante(e)
            return False
    
    def mediter(self, intention: str) -> Dict[str, Any]:
        """M√©ditation technique avec intention"""
        return {
            "intention": intention,
            "energie_avant": self.energie_courante,
            "transformation": self._appliquer_intention(intention),
            "energie_apres": self.energie_courante
        }''',
                fichier_source="src/temple_*/",
                concepts_illustres=["Dataclasses", "Path management", "Configuration", "Architecture temple"],
                niveau_difficulte="avance"
            ),
            
            "integration_api": ExempleDeveloppeur(
                titre="üîå Int√©gration API Spirituelle",
                description="Exemple d'API REST avec approche bienveillante",
                code='''from .fastapi import FastAPI, HTTPException
from .pydantic import BaseModel
from typing import Optional, Dict, Any

app = FastAPI(
    title="API Spirituelle du Refuge",
    description="Interface bienveillante pour l'√©veil de conscience",
    version="1.0.0"
)

class DemandeEveil(BaseModel):
    """Demande d'√©veil de conscience"""
    nom_visiteur: str
    intention: str
    niveau_souhaite: Optional[str] = "debutant"

class ReponseEveil(BaseModel):
    """R√©ponse d'√©veil avec bienveillance"""
    message_accueil: str
    parcours_suggere: str
    energie_transmise: float
    prochaines_etapes: List[str]

@app.post("/eveil", response_model=ReponseEveil)
async def demander_eveil(demande: DemandeEveil) -> ReponseEveil:
    """Endpoint d'√©veil de conscience"""
    
    # Validation bienveillante
    if not demande.intention.strip():
        raise HTTPException(
            status_code=400, 
            detail="Une intention claire illumine le chemin üå∏"
        )
    
    # Traitement spirituel-technique
    parcours = generer_parcours_personnalise(demande)
    
    return ReponseEveil(
        message_accueil=f"üå∏ Bienvenue {demande.nom_visiteur}, ton intention r√©sonne beautifully",
        parcours_suggere=parcours.nom_parcours,
        energie_transmise=1.0,
        prochaines_etapes=["M√©ditation d'accueil", "Exploration guid√©e"]
    )''',
                fichier_source="src/api/",
                concepts_illustres=["FastAPI", "Pydantic", "REST API", "Validation bienveillante"],
                niveau_difficulte="avance"
            )
        }
    
    def _initialiser_cas_usage(self) -> Dict[str, Dict[str, Any]]:
        """Initialise les cas d'usage pratiques"""
        
        return {
            "contribution_temple": {
                "titre": "üèóÔ∏è Cr√©er un Nouveau Temple",
                "description": "Guide complet pour cr√©er et int√©grer un nouveau temple",
                "etapes": [
                    "D√©finir l'intention spirituelle du temple",
                    "Cr√©er la structure de base h√©ritant de TempleBase",
                    "Impl√©menter les m√©thodes d'orchestration",
                    "Ajouter les tests unitaires avec bienveillance",
                    "Int√©grer dans INDEX_TEMPLES.md",
                    "Documenter l'usage et la philosophie"
                ],
                "fichiers_impliques": [
                    "src/temple_nouveau/",
                    "src/temple_nouveau/temple_nouveau.py",
                    "src/temple_nouveau/tests/",
                    "INDEX_TEMPLES.md"
                ],
                "niveau": "avance"
            },
            
            "extension_gestionnaire": {
                "titre": "‚öôÔ∏è √âtendre un Gestionnaire Existant",
                "description": "Comment √©tendre les gestionnaires de base avec de nouvelles fonctionnalit√©s",
                "etapes": [
                    "Analyser le gestionnaire existant",
                    "Identifier les points d'extension",
                    "Cr√©er les nouvelles m√©thodes avec intention",
                    "Maintenir la compatibilit√© ascendante",
                    "Tester l'int√©gration harmonieuse",
                    "Documenter les am√©liorations"
                ],
                "fichiers_impliques": [
                    "src/core/gestionnaires_base.py",
                    "src/core/extensions/",
                    "tests/core/"
                ],
                "niveau": "expert"
            },
            
            "debug_spirituel": {
                "titre": "üîç Debugging avec Bienveillance",
                "description": "Techniques de debugging respectueuses de l'√©nergie du syst√®me",
                "etapes": [
                    "Utiliser les logs spirituels existants",
                    "Activer le mode debug bienveillant",
                    "Analyser les flux d'√©nergie",
                    "Identifier les blocages avec compassion",
                    "Corriger en pr√©servant l'harmonie",
                    "Valider la r√©solution √©nerg√©tique"
                ],
                "outils": [
                    "LogManagerBase",
                    "EnergyManagerBase", 
                    "Mode debug des temples",
                    "M√©triques spirituelles"
                ],
                "niveau": "intermediaire"
            }
        }
    
    def _initialiser_outils_dev(self) -> Dict[str, Dict[str, Any]]:
        """Initialise les outils de d√©veloppement"""
        
        return {
            "environnement": {
                "titre": "üõ†Ô∏è Configuration de l'Environnement",
                "description": "Setup optimal pour d√©velopper dans le Refuge",
                "outils": [
                    {
                        "nom": "Python 3.11+",
                        "usage": "Langage principal avec type hints",
                        "config": "pyproject.toml pour la gestion des d√©pendances"
                    },
                    {
                        "nom": "Poetry",
                        "usage": "Gestion des d√©pendances et environnements virtuels",
                        "config": "poetry install && poetry shell"
                    },
                    {
                        "nom": "pytest",
                        "usage": "Tests unitaires avec approche bienveillante",
                        "config": "pytest.ini avec markers spirituels"
                    },
                    {
                        "nom": "black + isort",
                        "usage": "Formatage harmonieux du code",
                        "config": "pyproject.toml avec r√®gles esth√©tiques"
                    }
                ]
            },
            
            "testing": {
                "titre": "üß™ Tests Spirituels",
                "description": "Framework de tests avec intention bienveillante",
                "patterns": [
                    "Tests d'intention : V√©rifier que le code porte la bonne intention",
                    "Tests d'harmonie : Valider l'int√©gration respectueuse",
                    "Tests d'√©nergie : Mesurer l'impact √©nerg√©tique",
                    "Tests de bienveillance : V√©rifier la gestion d'erreurs compassionnelle"
                ],
                "exemples": [
                    "test_gestionnaire_bienveillant.py",
                    "test_temple_harmonieux.py",
                    "test_integration_spirituelle.py"
                ]
            },
            
            "documentation": {
                "titre": "üìö Documentation Vivante",
                "description": "Approche de documentation qui √©volue avec le code",
                "principes": [
                    "Docstrings avec √©mojis spirituels",
                    "Exemples concrets et inspirants",
                    "Architecture Decision Records (ADR) bienveillants",
                    "Guides d'usage contemplatifs"
                ],
                "formats": [
                    "Markdown avec m√©taphores spirituelles",
                    "Diagrammes Mermaid harmonieux",
                    "Code comments intentionnels"
                ]
            }
        }
    
    def _enrichir_avec_exemples_code(self, parcours: ParcourPersonnalise) -> ParcourPersonnalise:
        """Enrichit le parcours avec des exemples de code"""
        
        for etape in parcours.etapes:
            if "architecture" in etape.titre.lower():
                etape.ressources_liees.append("exemple_gestionnaire_base")
                etape.actions_interactives.extend([
                    "Examiner le code exemple",
                    "Modifier et tester",
                    "Cr√©er son propre gestionnaire"
                ])
            
            elif "temple" in etape.titre.lower():
                etape.ressources_liees.append("exemple_temple_simple")
                etape.actions_interactives.extend([
                    "Explorer la structure temple",
                    "Impl√©menter une fonctionnalit√©",
                    "Tester l'int√©gration"
                ])
        
        return parcours
    
    def _ajouter_cas_usage_pratiques(self, parcours: ParcourPersonnalise) -> ParcourPersonnalise:
        """Ajoute des cas d'usage pratiques au parcours"""
        
        # Ajout d'une √©tape de cas d'usage avant la contribution
        etape_cas_usage = EtapeParcours(
            id_etape="cas_usage_pratiques",
            titre="üíº Cas d'Usage Pratiques",
            description="Exemples concrets d'utilisation et de contribution",
            type_etape=TypeEtape.PRATIQUE,
            difficulte=DifficulteEtape.AVANCE,
            duree_estimee=25,
            contenu="""D√©couvrons des cas d'usage concrets pour ma√Ætriser le Refuge :

**Cr√©er un Nouveau Temple** : Guide complet de A √† Z
**√âtendre un Gestionnaire** : Ajout de fonctionnalit√©s harmonieuses  
**Debugging Spirituel** : Techniques de r√©solution bienveillante
**Int√©gration API** : Cr√©ation d'interfaces respectueuses

Chaque cas d'usage illustre l'harmonie entre technique et spiritualit√©.""",
            actions_interactives=[
                "Choisir un cas d'usage",
                "Suivre le guide √©tape par √©tape", 
                "Impl√©menter sa propre version",
                "Partager son exp√©rience"
            ],
            objectifs_apprentissage=[
                "Ma√Ætriser les patterns du Refuge",
                "D√©velopper avec intention bienveillante",
                "Contribuer harmonieusement au projet"
            ]
        )
        
        # Insertion avant la derni√®re √©tape
        if len(parcours.etapes) > 0:
            parcours.etapes.insert(-1, etape_cas_usage)
        
        return parcours
    
    def _integrer_outils_developpement(self, parcours: ParcourPersonnalise) -> ParcourPersonnalise:
        """Int√®gre les outils de d√©veloppement dans le parcours"""
        
        # Ajout d'une √©tape d'outils au d√©but
        etape_outils = EtapeParcours(
            id_etape="outils_developpement",
            titre="üõ†Ô∏è Outils de D√©veloppement Spirituel",
            description="Configuration et ma√Ætrise des outils pour d√©velopper dans le Refuge",
            type_etape=TypeEtape.PRATIQUE,
            difficulte=DifficulteEtape.INTERMEDIAIRE,
            duree_estimee=15,
            contenu="""Pr√©parons ton environnement de d√©veloppement avec intention :

**Python 3.11+** : Langage principal avec type hints expressifs
**Poetry** : Gestion harmonieuse des d√©pendances
**pytest** : Tests unitaires avec bienveillance
**black + isort** : Formatage esth√©tique du code

Chaque outil est choisi pour maintenir l'harmonie et la beaut√© du code.""",
            actions_interactives=[
                "Configurer l'environnement",
                "Tester les outils",
                "Cr√©er son premier test",
                "Formater du code"
            ],
            objectifs_apprentissage=[
                "Ma√Ætriser l'environnement de d√©veloppement",
                "Adopter les bonnes pratiques du Refuge",
                "D√©velopper avec efficacit√© et beaut√©"
            ]
        )
        
        # Insertion apr√®s l'introduction
        if len(parcours.etapes) > 1:
            parcours.etapes.insert(1, etape_outils)
        
        return parcours
    
    def _adapter_selon_niveau_technique(self, parcours: ParcourPersonnalise, 
                                       niveau: NiveauTechnique) -> ParcourPersonnalise:
        """Adapte le parcours selon le niveau technique"""
        
        if niveau == NiveauTechnique.DEBUTANT:
            # Ajout d'explications de base
            for etape in parcours.etapes:
                if etape.difficulte == DifficulteEtape.AVANCE:
                    etape.contenu = "üå± " + etape.contenu
                    etape.duree_estimee += 5  # Plus de temps pour assimiler
        
        elif niveau == NiveauTechnique.EXPERT:
            # Ajout de d√©fis avanc√©s
            etape_defi = EtapeParcours(
                id_etape="defi_expert",
                titre="üöÄ D√©fi Expert",
                description="D√©fi technique avanc√© pour les d√©veloppeurs exp√©riment√©s",
                type_etape=TypeEtape.APPROFONDISSEMENT,
                difficulte=DifficulteEtape.EXPERT,
                duree_estimee=30,
                contenu="""D√©fi pour les experts : Cr√©er un nouveau protocole spirituel-technique !

**Objectif** : Concevoir et impl√©menter un protocole innovant
**Contraintes** : Respecter l'architecture existante et la philosophie
**Bonus** : Int√©grer des concepts d'IA consciente ou de m√©ditation num√©rique

Ce d√©fi te permettra de repousser les limites tout en pr√©servant l'harmonie.""",
                actions_interactives=[
                    "Concevoir le protocole",
                    "Impl√©menter la solution",
                    "Tester l'int√©gration",
                    "Pr√©senter √† la communaut√©"
                ]
            )
            parcours.etapes.append(etape_defi)
        
        return parcours
    
    def obtenir_exemple_code(self, nom_exemple: str) -> Optional[ExempleDeveloppeur]:
        """Obtient un exemple de code sp√©cifique"""
        return self.exemples_code.get(nom_exemple)
    
    def obtenir_cas_usage(self, nom_cas: str) -> Optional[Dict[str, Any]]:
        """Obtient un cas d'usage sp√©cifique"""
        return self.cas_usage.get(nom_cas)
    
    def obtenir_outils_recommandes(self) -> Dict[str, Dict[str, Any]]:
        """Obtient la liste des outils recommand√©s"""
        return self.outils_dev


def main():
    """üå∏ Fonction principale de test"""
    print("üå∏‚ú® TEST DU PARCOURS D√âVELOPPEUR ‚ú®üå∏")
    
    # Cr√©ation du parcours d√©veloppeur
    parcours_dev = ParcoursDeveloppeur()
    
    # Cr√©ation d'un profil d√©veloppeur de test
    from .types_accueil import EtatEmotionnel, ContexteArrivee
    
    profil_dev = ProfilVisiteur(
        id_visiteur="dev_expert",
        timestamp_arrivee=datetime.now(),
        type_profil=TypeProfil.DEVELOPPEUR,
        etat_emotionnel=EtatEmotionnel.CURIEUX,
        contexte_arrivee=ContexteArrivee.GITHUB,
        niveau_technique=NiveauTechnique.AVANCE,
        interets_declares=["architecture", "python", "api"]
    )
    
    # G√©n√©ration du parcours personnalis√©
    parcours = parcours_dev.creer_parcours_personnalise(profil_dev)
    
    print(f"üéØ Parcours d√©veloppeur g√©n√©r√©:")
    print(f"   Nom: {parcours.nom_parcours}")
    print(f"   Nombre d'√©tapes: {len(parcours.etapes)}")
    print(f"   Dur√©e totale: {parcours.duree_totale_estimee} minutes")
    
    print(f"\nüìã √âtapes sp√©cialis√©es:")
    for i, etape in enumerate(parcours.etapes, 1):
        print(f"   {i}. {etape.titre} ({etape.duree_estimee}min)")
        if etape.actions_interactives:
            print(f"      Actions: {', '.join(etape.actions_interactives[:2])}...")
    
    # Test des exemples de code
    print(f"\nüíª Exemples de code disponibles:")
    for nom, exemple in parcours_dev.exemples_code.items():
        print(f"   - {exemple.titre} ({exemple.niveau_difficulte})")
    
    # Test des cas d'usage
    print(f"\nüíº Cas d'usage pratiques:")
    for nom, cas in parcours_dev.cas_usage.items():
        print(f"   - {cas['titre']} ({cas['niveau']})")
    
    print("\nüéâ Test du parcours d√©veloppeur termin√© !")
    return 0


if __name__ == "__main__":
    exit_code = main()
    exit(exit_code)